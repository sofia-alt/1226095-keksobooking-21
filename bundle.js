(()=>{"use strict";window.utils={changeDisabledElemetsForm:e=>{const t=window.map.getIsPageActive();for(let o=0;o<e.length;o++)e[o].disabled=!t},debounce:e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}}},(()=>{const e="GET",t="POST",o=(e,t)=>{let o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let n;switch(o.status){case 200:e(o.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;default:n="Cтатус ответа: : "+o.status+" "+o.statusText}n&&t(n)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o};window.backend={load:(t,n)=>{const r=o(t,n);r.open(e,"https://21.javascript.pages.academy/keksobooking/data"),r.send()},upload:(e,n,r)=>{const s=o(n,r);s.open(t,"https://21.javascript.pages.academy/keksobooking"),s.send(e)}}})(),(()=>{const e="any",t=(t,o)=>o===e||t.offer.type===o,o=(t,o)=>{switch(o){case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"low":return t.offer.price<1e4;case"high":return t.offer.price>5e4;default:return o===e}},n=(t,o)=>o===e||t.offer.rooms===parseInt(o,10),r=(t,o)=>o===e||t.offer.guests===parseInt(o,10),s=(e,t)=>t.every((t=>e.offer.features.includes(t)));window.filter={getFiltred:(e,a,i,d,l,c)=>{const u=[];for(let p=0;p<e.length;p++){const m=e[p];if(t(m,a)&&o(m,i)&&n(m,d)&&r(m,l)&&s(m,c)&&(u.push(m),5===u.length))break}return u}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={getElement:t=>{const{location:{x:o,y:n}}=t,r=e.cloneNode(!0);return r.querySelector("img").src=t.author.avatar,r.style.left=o-Math.floor(25)+"px",r.style.top=n-70+"px",((e,t)=>{e.addEventListener("click",(function(){window.card.renderPopup(t)}))})(r,t),r},pinTemplate:e}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.getElementsByTagName("fieldset"),o=e.querySelector("#room_number"),n=e.querySelector("#capacity"),r=e.querySelector("#title"),s=e.querySelector("#timein"),a=e.querySelector("#timeout"),i=e.querySelector("#type"),d=e.querySelector("#price"),l=e.querySelector("#address"),c=e.querySelector(".ad-form__reset"),u=document.querySelector("#error").content.querySelector(".error"),p=document.querySelector("#success").content.querySelector(".success");let m=null;const f=1e3,w=5e3,y=1e4;let v;const g=()=>{const e=parseInt(o.value,10),t=parseInt(n.value,10);let r="";(1===e&&1!==t||2===e&&1!==t&&2!==t||3===e&&0===t||100===e&&0!==t)&&(r="Неверное количество комнат"),o.setCustomValidity(r),n.setCustomValidity("")},h=()=>{const e=parseInt(o.value,10),t=parseInt(n.value,10);let r="";(1===t&&100===e||2===t&&2!==e&&3!==e||3===t&&3!==e||0===t&&100!==e)&&(r="Неверное количество гостей"),n.setCustomValidity(r),o.setCustomValidity("")},_=()=>{const{min:e,message:t,placeholder:o}=v[i.value];d.placeholder=o;const n=parseInt(d.value,10)<e?t:"";d.setCustomValidity(n)},S=()=>{e.classList.add("ad-form--disabled"),window.utils.changeDisabledElemetsForm(t),window.move.updateAddress()},q=()=>{window.map.fullReset(),window.card.closePopup(),window.photos.reset(),S(),e.reset(),window.move.updateAddress()},E=e=>{m=e.cloneNode(!0),document.body.append(m)},L=()=>{q(),E(p),A()},b=()=>{E(u),A()},k=()=>{null!==m&&(m.remove(),m=null,T())},x=e=>{27===e.keyCode&&(e.preventDefault(),k())},C=()=>{k()},A=()=>{document.addEventListener("keydown",x),document.addEventListener("click",C)},T=()=>{document.removeEventListener("keydown",x),document.removeEventListener("click",C)};c.addEventListener("click",(()=>{q()})),e.addEventListener("submit",(t=>{window.backend.upload(new FormData(e),L,b),t.preventDefault()})),window.form={activate:()=>{e.classList.remove("ad-form--disabled"),window.utils.changeDisabledElemetsForm(t),window.move.updateAddress()},init:()=>{v={[window.card.OfferType.BUNGALOW]:{min:0,placeholder:0,message:"Значение должно быть больше или равно 0"},[window.card.OfferType.FLAT]:{min:f,placeholder:f,message:"Значение должно быть больше или равно 1000"},[window.card.OfferType.HOUSE]:{min:w,placeholder:w,message:"Значение должно быть больше или равно 5000"},[window.card.OfferType.PALACE]:{min:y,placeholder:y,message:"Значение должно быть больше или равно 10000"}},S(),e.addEventListener("change",(function(t){switch(t.target.id){case o.id:g();break;case n.id:h();break;case a.id:s.value=a.value;break;case s.id:a.value=s.value;break;case i.id:_()}e.reportValidity()})),r.addEventListener("input",(function(){let e=r.value.length;e<30?r.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?r.setCustomValidity("Удалите лишние "+(e-100)+" симв."):r.setCustomValidity(""),r.reportValidity()})),g(),h(),_()},setAddress:({valueX:e,valueY:t})=>{l.value=`${e}, ${t}`}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),s=document.createElement("img"),a=e=>{o.src=e},i=e=>{r.appendChild(s),s.src=e,s.style.width=r.offsetWidth+"px",s.style.height=r.offsetHeight+"px"},d=(t,o)=>{const n=t.target.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e.result)})),e.readAsDataURL(n)}};window.photos={init:()=>{t.addEventListener("change",(e=>{d(e,a)})),n.addEventListener("change",(e=>{d(e,i)}))},reset:()=>{s.remove(),o.src="img/muffin-grey.svg"}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map"),o=document.querySelector(".map__filters"),n=o.getElementsByTagName("select"),r=o.querySelector("#housing-type"),s=o.querySelector("#housing-price"),a=o.querySelector("#housing-rooms"),i=o.querySelector("#housing-guests");let d=!1,l=[],c=[];const u=t=>{const o=document.createDocumentFragment();for(let e=0;e<t.length;e++){const n=t[e],r=window.pin.getElement(n);l.push(r),o.appendChild(r)}e.appendChild(o)},p=()=>{l.forEach((e=>{e.remove()})),l=[]},m=e=>{const t=document.createElement("p");t.style="z-index: 100; margin: 100px auto; text-align: center; border: 3px solid red; font-size: 30px; border-radius: 10px; width: auto; max-width: 600px; padding: 10px; background-color: white;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},f=()=>Array.from(o.querySelectorAll("#housing-features input:checked")).map((e=>e.value)),w=e=>{c=e,u(window.filter.getFiltred(c,r.value,s.value,a.value,i.value,f()))},y=()=>{d=!1,t.classList.add("map--faded")};window.map={getIsPageActive:()=>d,init:()=>{y(),o.addEventListener("change",window.utils.debounce((()=>{p(),window.card.closePopup(),u(window.filter.getFiltred(c,r.value,s.value,a.value,i.value,f()))})))},activateMap:()=>{d=!0,t.classList.remove("map--faded"),window.form.activate(),window.utils.changeDisabledElemetsForm(n),window.backend.load(w,m)},fullReset:()=>{p(),window.move.resetMainPin(),y(),o.reset(),window.utils.changeDisabledElemetsForm(n)},block:t}})(),(()=>{const e=document.querySelector(".map__overlay"),t=document.querySelector(".map__pin--main"),o=Math.floor(32.5),n=0-o,r=e.offsetWidth-o,s=(e,t)=>({valueX:e+o,valueY:t+(window.map.getIsPageActive()?87:Math.floor(32.5))}),a=()=>{const{offsetLeft:e,offsetTop:o}=t;window.form.setAddress(s(e,o))};window.move={pin:()=>{t.addEventListener("mousedown",(e=>{e.preventDefault(),window.map.getIsPageActive()||window.map.activateMap();let o={x:e.clientX,y:e.clientY};const i=e=>{e.preventDefault();let a=o.x-e.clientX,i=o.y-e.clientY;o={x:e.clientX,y:e.clientY};const d=t.offsetLeft-a,l=t.offsetTop-i;s(d,l),l>=43&&l<=543&&d>=n&&d<=r&&(t.style.left=d+"px",t.style.top=l+"px",window.form.setAddress(s(d,l)))},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",d),a();const o=e=>{e.preventDefault(),t.removeEventListener("click",o)};t.addEventListener("click",o)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",d)}))},updateAddress:a,resetMainPin:()=>{t.style.left="570px",t.style.top="375px"}}})(),(()=>{let e=null;const t=document.querySelector("#card").content.querySelector(".map__card"),o={FLAT:"flat",BUNGALOW:"bungalow",HOUSE:"house",PALACE:"palace"},n={[o.FLAT]:"Квартира",[o.BUNGALOW]:"Бунгало",[o.HOUSE]:"Дом",[o.PALACE]:"Дворец"},r=()=>{null!==e&&(e.remove(),e=null)};window.card={renderPopup:o=>{r();const{offer:{title:s,address:a,price:i,type:d,rooms:l,guests:c,checkin:u,checkout:p,features:m,description:f,photos:w},author:{avatar:y}}=o;e=t.cloneNode(!0),e.querySelector(".popup__title").textContent=s,e.querySelector(".popup__text--address").textContent=a,e.querySelector(".popup__text--price").textContent=i+"₽/ночь",e.querySelector(".popup__type").textContent=n[d],e.querySelector(".popup__text--capacity").textContent=`${l} комнаты для ${c} гостей`,e.querySelector(".popup__text--time").textContent=`Заезд после ${u}, выезд до ${p}`,e.querySelector(".popup__avatar").src=y,((e,t)=>{if(!t.length)return void e.remove();const o=e.querySelector(".popup__feature");e.innerHTML="",t.forEach((t=>{const n=o.cloneNode(!0);n.className="popup__feature popup__feature--"+t,e.appendChild(n)}))})(e.querySelector(".popup__features"),m),e.querySelector(".popup__description").textContent=f,((e,t)=>{if(!t.length)return void e.remove();const o=e.querySelector(".popup__photo");e.innerHTML="",t.forEach((t=>{const n=o.cloneNode(!0);n.src=""+t,e.appendChild(n)}))})(e.querySelector(".popup__photos"),w),window.map.block.appendChild(e),e.querySelector(".popup__close").addEventListener("click",(()=>{r()})),window.map.block.addEventListener("keydown",(e=>{27===e.keyCode&&(e.preventDefault(),r())}))},closePopup:r,OfferType:o}})(),window.map.init(),window.move.pin(),window.form.init(),window.photos.init()})();